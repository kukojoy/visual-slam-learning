# 第13讲 实践：设计SLAM系统

## 13.1 为什么要单独列工程章节

在前面的章节中，学习并理解了前端、后端、回环检测、建图等各个模块的原理。但是，知道了它们的原理，并不意味着就可以直接构建一个完整的SLAM系统。在SLAM中，工程实现和理解算法原理至少是同等重要的，甚至更应强调如何书写实际可用的程序。

一个实用的程序会有很多的工程设计和技巧，还需要讨论每一步出现问题之后该如何处理。原则上，每个人实现的SLAM都会有所不同，并且各有优劣，很难绝对地判断哪种方法就一定更好。但是，我们通常会遇到一些共性的问题，例如：“如何选择关键帧”“如何处理误匹配”，等等。

在本讲中，会像搭积木一样，**从简单到复杂**，逐步搭建一个SLAM系统，实现一个由光流追踪的前端和一个局部BA的后端组成的双目视觉里程计。学习这个过程蕴含的**工程思想**是非常重要的。

**注：**我理解的**工程思想**包括：工程的框架（狭义上指工程目录的结构）、面向对象的模块化编程思想、算法的具体流程框架、一些工程trick（不一定有严谨的理论依据，但通常能work）。

## 13.2 工程思想

### 13.2.1 工程框架

大多数工程都会按照模块对文件进行分类存放，包括：

1. 头文件（include），主要是.h文件。
2. 源文件（src），主要是.cpp文件。
3. 库文件（lib），在Linux中，包括动态库（.so）和静态库（.a）。
4. 二进制文件（bin），通常是编译得到的可执行文件。
5. 第三方库（3rdparty），一些环境依赖。
6. 配置文件（config），主要包括传感器参数和算法中的参数，也可能包括可视化工具的一些参数。
7. 数据集（dataset），主要用来放置各种数据集。
8. cmake_modules，存放第三方库的cmake文件。
9. 应用/测试文件（app/test），工程的上层应用（面向用户）和测试程序（面向测试人员），通常是用于生成可执行文件的.cpp源文件。
10. 各种夹杂在项目各处的CMakeLists.txt，构建目录（build），各种shell脚本（如./build.sh），通常与项目的构建有关，与算法本身无直接关系。

从github上任意找几个SLAM的开源项目看，就能发现它们总体上都是这样的结构，但可能有些微的差别。例如，有些没有bin目录，有些没有config目录，但不必纠结这些，重点是要能理清它们的作用和相互关系（起码要知道：每个文件的作用是什么，要读取的文件在哪，生成的文件去了哪），方便管理和维护。

### 13.2.2 算法流程

为了简单，本讲的例程先不考虑回环检测以及复杂的建图，因此，这个**SLAM系统主要就包括前端和后端**，前端负责对相邻图像进行光流追踪，估计位姿并计算路标，后端负责优化从前端传递过来的数据，最终得到由各时刻位姿所组成的轨迹、关键帧和稀疏的路标点。在典型的实现中，**二者应该有各自的线程**，前端快速处理保证实时性，后端优化关键帧以保证良好的结果。

### 13.2.3 数据结构

**程序 = 数据结构 + 算法**，这个朴素的观点虽然在复杂工程中显得过于简化了（实际工程中，还涉及到并发处理等众多因素），但还是可以提供很有效的指导。设想，要实现上面规划好的算法流程，在细节上肯定要利用**面向对象**的编程思想，先写好很多**类**，封装好帧、特征点、路标等直接操作的**基本数据**，以及相机、数据集加载器等一些**实用工具**。

## 13.3 实现

**注：**这里就不“具体见代码”了，虽然是实现一个非常简易的VO，但是对没有实际工程经验的初学者来说，还是具有一定复杂性的。要从头自己体会全过程，看懂每一行代码，把这个简易的VO搞得非常透，以后才知道怎么分析更复杂的工程。

### 13.3.0 阅读代码的顺序

一般都是从头文件（include）出发，先看给出的许多定义、声明，然后在源文件（src）中找到具体的实现。其实也可以递归式地看代码，从上层应用开始看，碰到不会的就向底层代码递归，但对于我来说，这样容易乱，一直看不懂一直递归，然后找不到路就放弃了。一个比较适合我的方法是从两头往中间看，先大致了解一下底层接口，再看看上层是怎么调这些接口的，主要是理解类中定义的属性和方法到底有什么样的意图，具体如何实现其实是次要的。

但是，无论是什么顺序，都要有良好的C++基础，碰到不了解的语法或者书写方式，一定要搞明白，不然就是似懂非懂，其实不懂。

### 13.3.1 基本数据结构

清单（共11个模块）：

- [x] common_include
- [x] config
- [x] camera
- [x] frame
- [x] feature
- [x] mappoint
- [x] map
- [x] dataset
- [ ] viewer
- [ ] g2o_types
- [ ] algorithm

### 13.3.2 前端

- [x] frontend

### 13.3.3 后端

- [x] backend

### 13.3.4 完整的视觉里程计

- [x] visual_odometry

### 13.4 实验效果



